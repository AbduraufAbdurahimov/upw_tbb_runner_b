<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes" id="viewport-meta">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Runner</title>
    <style>
      /* Modal styles */
      #player-name-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1002;
      }
      
      #player-name-dialog {
        background: #2a3a38;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        color: white;
        font-family: Arial, sans-serif;
      }
      
      #player-name-input {
        width: 250px;
        height: 40px;
        padding: 0;
        margin: 15px 0;
        border: none;
        border-radius: 0;
        outline: none;
        font-size: 16px;
        text-align: center;
        background-image: url('sv_inp.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        background-color: transparent;
      }
      
      #confirm-name-btn {
        background-image: url('sv_btn.png');
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        background-color: transparent;
        border: none;
        outline: none;
        box-shadow: none;
        cursor: pointer;
        margin: 10px 0;
        padding: 0;
        min-width: 150px;
        min-height: 80px;
      }
      
      #confirm-name-btn:hover {
        opacity: 0.8;
      }
      
      /* Fullscreen button styles */
      #fullscreen-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(42, 58, 56, 0.8);
        border: 2px solid #29d;
        border-radius: 8px;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1003;
        transition: all 0.3s ease;
      }
      
      #fullscreen-btn:hover {
        background: rgba(42, 58, 56, 1);
        transform: scale(1.1);
      }
      
      #fullscreen-btn svg {
        width: 20px;
        height: 20px;
        fill: #29d;
      }
      
      /* iOS fullscreen styles */
      .ios-fullscreen {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999 !important;
      }
      
      .ios-fullscreen canvas {
        width: 100vw !important;
        height: 100vh !important;
      }
      
      /* Hide address bar on iOS */
      @supports (-webkit-touch-callout: none) {
        .ios-fullscreen {
          height: 100vh !important;
          height: -webkit-fill-available !important;
        }
      }
    </style>
  </head>
  <body style="text-align: left; padding: 0; border: 0; margin: 0; background-color: #1A2321;">
    
    <!-- Centered container for logo and loading bar -->
    <div id="unity-loading-container" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); display:flex; flex-direction:column; align-items:center; gap:30px; z-index:1001;">
      <!-- Logo -->
      <div id="unity-logo">
        <img src="logo1.PNG" alt="Logo" style="max-width:500px; max-height:350px; width:auto; height:auto;">
      </div>
      
      <!-- Loading bar -->
      <div id="unity-loading-bar" style="width:300px; height:20px; background:#444; border-radius:10px; padding:2px;">
        <div id="unity-progress-bar" style="width:0%; height:100%; background:#29d; border-radius:8px; transition:width 0.3s ease;"></div>
      </div>

      <!-- Play button -->
      <div id="unity-play-button" style="width:180px; height:180px;  border:none; cursor:pointer; display:none; align-items:center; justify-content:center;">
        <img src="sv_pl.png" alt="Play" style="width:180px; height:180px;">
      </div>
    </div>

    <!-- Player name modal -->
    <div id="player-name-modal">
      <div id="player-name-dialog">
        <h2>Geben Sie Ihren Namen ein</h2>
        <input type="text" id="player-name-input" placeholder="Ihr Name..." maxlength="20">
        <br>
        <button id="confirm-name-btn"></button>
      </div>
    </div>

    <!-- Fullscreen button -->
    <button id="fullscreen-btn" title="Enter Fullscreen">
      <svg viewBox="0 0 24 24">
        <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
      </svg>
    </button>

    <canvas id="unity-canvas" width=960 height=600 tabindex="-1"
      style="width:100%; height:100%; position:fixed; background: #231F20; display:none;"></canvas>

    <script src="Build/upw_tbb_runner_b.loader.js"></script>
    <script>
      var canvas = document.querySelector("#unity-canvas");
      var loadingContainer = document.getElementById("unity-loading-container");
      var loadingBar = document.getElementById("unity-loading-bar");
      var progressBar = document.getElementById("unity-progress-bar");
      var playButton = document.getElementById("unity-play-button");
      var logo = document.getElementById("unity-logo");
      var playerNameModal = document.getElementById("player-name-modal");
      var playerNameInput = document.getElementById("player-name-input");
      var confirmNameBtn = document.getElementById("confirm-name-btn");
      var fullscreenBtn = document.getElementById("fullscreen-btn");
      var unityInstancePromise;
      var isIOSFullscreen = false;

      // Detect iOS
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
               (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }

      // iOS fullscreen implementation
      function enterIOSFullscreen() {
        const viewport = document.getElementById('viewport-meta');
        const body = document.body;
        const html = document.documentElement;
        
        // Modify viewport for fullscreen
        viewport.setAttribute('content', 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, viewport-fit=cover');
        
        // Add fullscreen class
        body.classList.add('ios-fullscreen');
        html.classList.add('ios-fullscreen');
        
        // Hide address bar
        window.scrollTo(0, 1);
        
        // Set flag
        isIOSFullscreen = true;
        
        // Force canvas resize
        setTimeout(() => {
          if (window.unityInstance) {
            canvas.style.width = '100vw';
            canvas.style.height = '100vh';
            window.unityInstance.SetFullscreen(1);
          }
        }, 100);
        
        fullscreenBtn.style.display = "none";
      }

      // Exit iOS fullscreen
      function exitIOSFullscreen() {
        const viewport = document.getElementById('viewport-meta');
        const body = document.body;
        const html = document.documentElement;
        
        // Restore viewport
        viewport.setAttribute('content', 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes');
        
        // Remove fullscreen class
        body.classList.remove('ios-fullscreen');
        html.classList.remove('ios-fullscreen');
        
        // Set flag
        isIOSFullscreen = false;
        
        fullscreenBtn.style.display = "flex";
      }

      // Function to start the game
      function startGame() {
        loadingContainer.style.display = "none";
        playButton.style.display = "none";
        playerNameModal.style.display = "none";
        canvas.style.display = "block";
        
        if (isIOS()) {
          enterIOSFullscreen();
        } else {
          unityInstance.SetFullscreen(1);
          setTimeout(checkFullscreenStatus, 500);
        }
        
        // Enable capture blocking in Unity
        unityInstance.SendMessage("WebMessageReceiver", "EnableCaptureBlocking");
      }

      // Function to check fullscreen status and show/hide button accordingly
      function checkFullscreenStatus() {
        if (isIOS()) {
          fullscreenBtn.style.display = isIOSFullscreen ? "none" : "flex";
        } else {
          const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || 
                                  document.mozFullScreenElement || document.msFullscreenElement);
          fullscreenBtn.style.display = isFullscreen ? "none" : "flex";
        }
      }

      // Function to enter fullscreen
      function enterFullscreen() {
        if (isIOS()) {
          if (isIOSFullscreen) {
            exitIOSFullscreen();
          } else {
            enterIOSFullscreen();
          }
        } else {
          const elem = document.documentElement;
          if (elem.requestFullscreen) {
            elem.requestFullscreen();
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          } else if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
        }
      }

      // Function to check and handle player name
      function checkPlayerName() {
        const storedName = localStorage.getItem('playerName');
        if (storedName && storedName.trim() !== '') {
          // Send stored player name to Unity
          unityInstance.SendMessage("WebMessageReceiver", "SetMyName", storedName);

          startGame();
        } else {
          playerNameModal.style.display = "flex";
          playerNameInput.focus();
        }
      }

      // Confirm name button handler
      confirmNameBtn.onclick = () => {
        const playerName = playerNameInput.value.trim();
        if (playerName !== '') {
          localStorage.setItem('playerName', playerName);
          // Send player name to Unity
          unityInstance.SendMessage("WebMessageReceiver", "SetMyName", playerName);
          startGame();
        } else {
          alert('Bitte geben Sie einen gültigen Namen ein');
        }
      };

      // Enter key handler for input
      playerNameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          confirmNameBtn.click();
        }
      });

      // Fullscreen button click handler
      fullscreenBtn.onclick = enterFullscreen;

      // Listen for orientation changes on iOS
      if (isIOS()) {
        window.addEventListener('orientationchange', () => {
          setTimeout(() => {
            if (isIOSFullscreen) {
              window.scrollTo(0, 1);
              if (window.unityInstance) {
                canvas.style.width = '100vw';
                canvas.style.height = '100vh';
              }
            }
          }, 500);
        });

        // Listen for viewport changes
        window.addEventListener('resize', () => {
          if (isIOSFullscreen) {
            setTimeout(() => {
              window.scrollTo(0, 1);
            }, 100);
          }
        });
      }

      // Listen for fullscreen changes to show/hide the button
      document.addEventListener('fullscreenchange', checkFullscreenStatus);
      document.addEventListener('webkitfullscreenchange', checkFullscreenStatus);
      document.addEventListener('mozfullscreenchange', checkFullscreenStatus);
      document.addEventListener('MSFullscreenChange', checkFullscreenStatus);

      unityInstancePromise = createUnityInstance(canvas, {
        arguments: [],
        dataUrl: "Build/upw_tbb_runner_b.data",
        frameworkUrl: "Build/upw_tbb_runner_b.framework.js",
        codeUrl: "Build/upw_tbb_runner_b.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName:   "Gamenock",
        productName:   "Runner",
        productVersion:"1.8",
      },
      // progress callback:
      (progress) => {
        progressBar.style.width = (100 * progress) + "%";
      }).then((unityInstance) => {
        window.unityInstance = unityInstance;
        // hide only loading bar and show play button, keep logo visible
        loadingBar.style.display = "none";
        playButton.style.display = "flex";
        
        // Play button click handler - now checks for player name
        playButton.onclick = checkPlayerName;
        
        return unityInstance;
      }).catch((message) => {
        alert(message);
      });
    </script>
  </body>
</html>
